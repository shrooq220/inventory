{% extends 'base.html' %}
{% load static %} {# تأكد من تحميل static هنا أيضاً #}

{% block title %}لوحة تحكم المستخدم{% endblock %}

{% block content %}
<h1 class="text-center mb-4 text-primary fw-bold">المنتجات المتاحة</h1>

<div class="row mb-4">
    <div class="col-md-6">
        <form method="get" action="{% url 'dashboard' %}" class="input-group"> {# تم تحديث اسم الـ URL هنا #}
            <input type="text" name="q" class="form-control" placeholder="ابحث عن منتج..." value="{{ query }}">
            <button type="submit" class="btn btn-outline-primary">بحث</button>
        </form>
    </div>
    <div class="col-md-6 mt-3 mt-md-0">
        <form method="get" action="{% url 'dashboard' %}" class="input-group"> {# تم تحديث اسم الـ URL هنا #}
            <label for="category-select" class="input-group-text">الفئة:</label>
            <select name="category" id="category-select" class="form-select">
                <option value="all" {% if category == 'all' %}selected{% endif %}>جميع الفئات</option>
                <option value="medical_tools" {% if category == 'medical_tools' %}selected{% endif %}>أدوات طبية</option>
                <option value="consumables" {% if category == 'consumables' %}selected{% endif %}>مواد استهلاكية</option>
                {# أضف المزيد من الفئات هنا حسب الحاجة #}
            </select>
            <button type="submit" class="btn btn-outline-primary">تصفية</button>
        </form>
    </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for product in products %}
    <div class="col">
        <div class="card h-100">
            {% if product.image %}
                <img src="{% if product.image.url %}{{ product.image.url }}{% else %}{% static 'placeholder.png' %}{% endif %}" class="card-img-top img-fluid" alt="{{ product.name }}" style="height: 200px; object-fit: contain; padding: 10px;">
            {% else %}
                <div class="d-flex justify-content-center align-items-center bg-light" style="height: 200px;">
                    <span class="text-muted">لا توجد صورة</span>
                </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text text-muted small">{{ product.description|default:"لا يوجد وصف." }}</p>
                <p class="card-text fw-bold">الكمية المتاحة: <span class="text-primary">{{ product.quantity }}</span></p>
                
                <div class="mt-auto"> {# يدفع المحتوى إلى الأسفل #}
                    {% if product.quantity > 0 %}
                        <form method="post" class="d-flex align-items-center">
                            {% csrf_token %} {# تأكد من وجود هذا السطر #}
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <div class="input-group input-group-sm me-2" style="width: 120px;">
                                <button type="button" class="btn btn-outline-secondary" onclick="decrementQuantity('qty-{{ product.id }}')">-</button>
                                <input type="number" id="qty-{{ product.id }}" name="quantity" value="1" min="1" max="{{ product.quantity }}" class="form-control text-center" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="incrementQuantity('qty-{{ product.id }}', {{ product.quantity }})">+</button>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                <i class="fas fa-cart-plus me-1"></i> إضافة للسلة
                            </button>
                        </form>
                    {% else %}
                        <span class="badge bg-danger p-2 w-100">نفذ المخزون</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
            لا توجد منتجات مطابقة لمعايير البحث أو التصفية.
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function incrementQuantity(inputId, max) {
        const input = document.getElementById(inputId);
        let value = parseInt(input.value);
        if (value < max) {
            input.value = value + 1;
        }
    }

    function decrementQuantity(inputId) {
        const input = document.getElementById(inputId);
        let value = parseInt(input.value);
        if (value > 1) { // لا تسمح بأن تكون الكمية أقل من 1
            input.value = value - 1;
        }
    }
</script>
{% endblock %}
     input.value = value + 1;
        }
    }

    function decrementQuantity(inputId) {
        const input = document.getElementById(inputId);
        let value = parseInt(input.value);
        if (value > 1) { // لا تسمح بأن تكون الكمية أقل من 1
            input.value = value - 1;
        }
    }
</script>
{% endblock %}
